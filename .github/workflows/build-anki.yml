name: Build anki server Image

on:
  # 1. 手动触发配置
  workflow_dispatch:
    inputs:
      version_tag:
        description: "设定镜像 Tag (例如: v0.52.0 或 latest)"
        required: false
        default: "latest"
        type: string

  # 2. 修改触发配置
  push:
    branches:
      - main # 或者 master，根据你的主分支名字修改
    paths:
      - "anki/**"
      - ".github/workflows/build-anki.yml" # 或者是修改了这个流水线文件本身

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/ankis

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    # 这一步非常重要：给予写入 GitHub Packages 的权限
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository (拉取代码)
        uses: actions/checkout@v4

      - name: Log in to the Container registry (登录镜像仓库)
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }} # GitHub 自动生成的令牌，无需手动设置

      - name: Set up QEMU (配置多架构支持环境)
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx (配置构建工具)
        uses: docker/setup-buildx-action@v3

      - name: Extract metadata (准备镜像标签)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            # 如果是手动触发，使用输入的 version_tag
            type=raw,value=${{ inputs.version_tag }},enable=${{ github.event_name == 'workflow_dispatch' }}
            # 如果是 Push 触发，默认打上 latest 标签
            type=raw,value=latest,enable=${{ github.event_name == 'push' }}

      - name: Build and push (构建并推送)
        uses: docker/build-push-action@v5
        with:
          context: ./anki # Dockerfile 所在的目录
          file: ./anki/Ankis.Dockerfile # Dockerfile 的具体路径
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          platforms: linux/amd64,linux/arm64 # 同时构建电脑版和树莓派/Mac版
          cache-from: type=gha # 使用 GitHub Actions 缓存加速构建
          cache-to: type=gha,mode=max
